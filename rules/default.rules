var int Timeout
var int Timeout1
var int Timeout2
var int Timeout3

//------------------------------------------------------------------------
// obrabotka nazatiya viklyuchatelya v koridore. men'she sekundi - vkluchaem/vikluchaem. bol'she sekundi - vikluchaem svet vo vsei kvartire

rule "Corridor start timer"
when Item itemD0P2 changed to ON then
 Timeout = now.getMillisOfDay
 logInfo("StartTime", Timeout.toString)
end

rule "Corridor stop timer"
when Item itemD0P2 changed to OFF then
var int Stop = now.getMillisOfDay
logInfo("StopTime", Timeout.toString)
var int result = Stop - Timeout
result = result / 1000

 if (result <= 1) {
 	logInfo("Timer 1 second ", result.toString)
 	if (itemD0P11.state == OFF){
	logInfo("viklu4en -> vklu4aem", result.toString)
        sendCommand(itemD0P11, ON)
		postUpdate(itemD0P11, ON) 
    } else {
	logInfo("vklu4eno -> viklu4aem", result.toString)
		sendCommand(itemD0P11, OFF)
		postUpdate(itemD0P11, OFF)
    }
 }
 else if (result > 1){
 		sendCommand(itemAllOff, ON)
		postUpdate(itemAllOff, ON)
		logInfo("Timer > 1 sec", result.toString)
 	  } 
end

//------------------------------------------------------------------------
// Обработка нажатия выключателя в спальне ближний к кровати. Меньше секунды просто переключение, дольше секунды - режим сна

rule "Bedroom start timer"
when Item itemD0P18 changed to ON then
 Timeout1 = now.getMillisOfDay
 logInfo("StartTime", Timeout1.toString)
end

rule "Bedroom stop timer"
when Item itemD0P18 changed to OFF then
var int Stop1 = now.getMillisOfDay
logInfo("StopTime", Timeout1.toString)
var int result1 = Stop1 - Timeout1
result1 = result1 / 1000

 if (result1 <= 1) {
 	logInfo("Timer 1 second ", result1.toString)
 	if (itemD0P25.state as DecimalType > 0){
		logInfo("vklu4eno -> viklu4aem", result1.toString)
        sendCommand(itemD0P25, 0)
		postUpdate(itemD0P25, 0) 
    } else {
		logInfo("viklu4en -> vklu4aem", result1.toString)
		sendCommand(itemD0P25, 100)
		postUpdate(itemD0P25, 100)
    }
 }
 else if (result1 > 1){
		sendCommand(itemD0P25, 0)
		postUpdate(itemD0P25, 0)
		postUpdate(WeSleepBedroom, ON)
		postUpdate(FullLightKitchen, OFF)
		logInfo("Timer > 1 sec", result1.toString)
 	  } 
end


//------------------------------------------------------------------------
// Обработка нажатия выключателя в спальне ближний к кровати. Меньше секунды просто переключение, дольше секунды - режим сна

rule "cheldren start timer"
when Item itemD0P16 changed to ON then
 Timeout2 = now.getMillisOfDay
 logInfo("StartTime", Timeout2.toString)
end

rule "cheldren stop timer"
when Item itemD0P16 changed to OFF then
var int Stop2 = now.getMillisOfDay
logInfo("StopTime", Timeout2.toString)
var int result2 = Stop2 - Timeout2
result2 = result2 / 1000

 if (result2 <= 1) {
 	logInfo("Timer 1 second ", result2.toString)
 	if (itemD0P27.state as DecimalType > 0){
        sendCommand(itemD0P27, 0)
		postUpdate(itemD0P27, 0) 
		logInfo("vklu4eno -> viklu4aem", result2.toString)
    } else {
		sendCommand(itemD0P27, 100)
		postUpdate(itemD0P27, 100)
		logInfo("viklu4en -> vklu4aem", result2.toString)
    }
 }
 else if (result2 > 1){
		sendCommand(itemD0P27, 0)
		postUpdate(itemD0P27, 0)
		postUpdate(WeSleepChildrensroom, ON)
		logInfo("Timer > 1 sec", result2.toString)
 	  } 
end

//------------------------------------------------------------------------
// Обработка нажатия выключателя в кухне дальнего от двери. Меньше секунды просто переключение, дольше секунды - режим вечерний

rule "kitchen start timer"
when Item itemD0P5 changed to ON then
 Timeout3 = now.getMillisOfDay
 logInfo("StartTime", Timeout3.toString)
end

rule "kitchen stop timer"
when Item itemD0P5 changed to OFF then
var int Stop2 = now.getMillisOfDay
logInfo("StopTime", Stop2.toString)
var int result2 = Stop2 - Timeout3
result2 = result2 / 1000

 if (result2 <= 1) {
 	logInfo("Timer 1 second ", result2.toString)
 	if (itemD0P28.state as DecimalType > 0){
        sendCommand(itemD0P28, 0)
		postUpdate(itemD0P28, 0) 
		logInfo("vklu4eno -> viklu4aem", result2.toString)
    } else {
		sendCommand(itemD0P28, 100)
		postUpdate(itemD0P28, 100)
		logInfo("viklu4en -> vklu4aem", result2.toString)
    }
 }
 else if (result2 > 1){
		if (FullLightKitchen.state  == OFF){
			postUpdate(FullLightKitchen, ON)
		} else {
			postUpdate(FullLightKitchen, OFF)
		}
 	  } 
end


//--------------------------------------------------
rule "0" //нажали выключатель ванная 1  
when
		Item itemD0P0 changed to ON
then
		if (itemD0P13.state as DecimalType > 0)
		{
			sendCommand(itemD0P13, 0)
			postUpdate(itemD0P13, 0)
			sendCommand(itemD0P26, OFF)
			postUpdate(itemD0P26, OFF)
			logInfo("vanna", "нажали выключатель, выключаю свет ванной")
		}
		else
		{
			sendCommand(itemD0P13, 100)
			postUpdate(itemD0P13, 100)
			sendCommand(itemD0P26, ON)
			postUpdate(itemD0P26, ON)
			logInfo("vanna", "нажали выключатель, включаю свет ванной")
		}
end
//--------------------------------------------------
rule "1" //нажали выключатель ванная 2 
when
		Item itemD0P1 changed to ON
then
		if (itemD0P12.state as DecimalType > 0)
		{
			sendCommand(itemD0P12, 0)
			postUpdate(itemD0P12, 0)
		}
		else
		{
			sendCommand(itemD0P12, 100)
			postUpdate(itemD0P12, 100)
		}
end
//--------------------------------------------------
/*
rule "2" //нажали выключатель коридор 1
when
		Item itemD0P2 changed to ON
then
		if (itemD0P11.state == ON)
		{
			sendCommand(itemD0P11, OFF)
			postUpdate(itemD0P11, OFF)
		}
		else
		{
			sendCommand(itemD0P11, ON)
			postUpdate(itemD0P11, ON)
		}
end
*/
//--------------------------------------------------
rule "3" //нажали выключатель коридор 2
when
		Item itemD0P3 changed to ON
then
		if (itemD0P12.state as DecimalType > 0)
		{
			sendCommand(itemD0P12, 0)
			postUpdate(itemD0P12, 0)
		}
		else
		{
			sendCommand(itemD0P12, 100)
			postUpdate(itemD0P12, 100)
		}
end
//--------------------------------------------------

rule "4" //нажали выключатель кухня 1
when
		Item itemD0P4 changed to ON
then
		if (itemD0P10.state as DecimalType > 0)
		{
			sendCommand(itemD0P10, 0)
			postUpdate(itemD0P10, 0)
		}
		else
		{
			sendCommand(itemD0P10, 100)
			postUpdate(itemD0P10, 100)
		}
		logInfo("kitchen", "нажали выключатель 1")
end

//--------------------------------------------------
/*
rule "5" //нажали выключатель кухня 2
when
		Item itemD0P5 changed to ON
then
		if (itemD0P28.state as DecimalType > 0)
		{
			sendCommand(itemD0P28, 0)
			postUpdate(itemD0P28, 0)
		}
		else
		{
			sendCommand(itemD0P28, 100)
			postUpdate(itemD0P28, 100)
		}
		logInfo("kitchen", "нажали выключатель 1")
end
*/
//--------------------------------------------------
rule "15" //нажали выключатель детская 1
when
		Item itemD0P15 changed to ON
then
		if (itemD0P27.state as DecimalType > 0)
		{
			sendCommand(itemD0P27, 0)
			postUpdate(itemD0P27, 0)
		}
		else
		{
			sendCommand(itemD0P27, 100)
			postUpdate(itemD0P27, 100)
		}
end
//--------------------------------------------------
/*
rule "16" //нажали выключатель детская 2
when
		Item itemD0P16 changed to ON
then
		if (itemD0P27.state as DecimalType > 0)
		{
			sendCommand(itemD0P27, 0)
			postUpdate(itemD0P27, 0)
		}
		else
		{
			sendCommand(itemD0P27, 100)
			postUpdate(itemD0P27, 100)
		}
end
*/
//--------------------------------------------------
rule "17" //нажали выключатель спальня 1
when
		Item itemD0P17 changed to ON
then
		if (itemD0P25.state as DecimalType > 0)
		{
			sendCommand(itemD0P25, 0)
			postUpdate(itemD0P25, 0)
		}
		else
		{
			sendCommand(itemD0P25, 100)
			postUpdate(itemD0P25, 100)
		}
end
//--------------------------------------------------
/*
rule "18" //нажали выключатель спальня 2
when
		Item itemD0P18 changed to ON
then
		if (itemD0P25.state as DecimalType > 0)
		{
			sendCommand(itemD0P25, 0)
			postUpdate(itemD0P25, 0)
		}
		else
		{
			sendCommand(itemD0P25, 100)
			postUpdate(itemD0P25, 100)
		}
end
*/
//--------------------------------------------------
rule "alloff" //выключаем всё
when
		Item itemAllOff changed to ON
then		
		sendCommand(itemD0P10, 0)
		postUpdate(itemD0P10, 0)
		
		sendCommand(itemD0P11, OFF)
		postUpdate(itemD0P11, OFF)
		
		sendCommand(itemD0P12, 0)
		postUpdate(itemD0P12, 0)
		
		sendCommand(itemD0P13, 0)
		postUpdate(itemD0P13, 0)
		
		sendCommand(itemD0P25, 0)
		postUpdate(itemD0P25, 0)
		
		sendCommand(itemD0P26, OFF)
		postUpdate(itemD0P26, OFF)
		
		sendCommand(itemD0P27, 0)
		postUpdate(itemD0P27, 0)
		
		sendCommand(itemD0P28, 0)
		postUpdate(itemD0P28, 0)
		
		sendCommand(itemKitchenCountertop, OFF)
		postUpdate(itemKitchenCountertop, OFF)
		sendHttpGetRequest("http://192.168.0.15/sec/?pt=35&ws=000000")
		
		
		sendCommand(itemAllOff, OFF)
		postUpdate(itemAllOff, OFF)
end
//--------------------------------------------------